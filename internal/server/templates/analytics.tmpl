{{template "layout" .}}

{{define "content"}}
<div class="page-header">
  <h2 class="page-title">Analytics</h2>
  <p class="page-subtitle">Bandwidth usage and performance metrics</p>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
  <div class="stat-card">
    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
    </div>
    <div class="stat-content">
      <div class="stat-label">Total Download</div>
      <div class="stat-value" id="totalRx">--</div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
    </div>
    <div class="stat-content">
      <div class="stat-label">Total Upload</div>
      <div class="stat-value" id="totalTx">--</div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
    </div>
    <div class="stat-content">
      <div class="stat-label">Active Peers</div>
      <div class="stat-value" id="activePeers">--</div>
    </div>
  </div>

  <div class="stat-card">
    <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
    </div>
    <div class="stat-content">
      <div class="stat-label">Avg CPU Usage</div>
      <div class="stat-value" id="avgCpu">--</div>
    </div>
  </div>
</div>

<div class="card" style="margin-bottom: 1.5rem;">
  <div class="card-header">
    <div class="card-title">Bandwidth Over Time</div>
    <div class="period-selector">
      <button class="period-btn active" data-period="24h" onclick="changePeriod('24h')">24H</button>
      <button class="period-btn" data-period="7d" onclick="changePeriod('7d')">7D</button>
      <button class="period-btn" data-period="30d" onclick="changePeriod('30d')">30D</button>
    </div>
  </div>
  <div class="card-body" style="padding: 1.5rem;">
    <canvas id="bandwidthChart" style="max-height: 400px;"></canvas>
  </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
  <div class="card">
    <div class="card-header">
      <div class="card-title">Top Clients by Bandwidth</div>
    </div>
    <div id="topClientsContainer">
      <div style="padding: 3rem; text-align: center;">
        <div class="spinner"></div>
        <p style="margin-top: 1rem; color: var(--gray-500);">Loading...</p>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div class="card-title">System Resources</div>
    </div>
    <div class="card-body" style="padding: 1.5rem;">
      <canvas id="resourceChart" style="max-height: 300px;"></canvas>
    </div>
  </div>
</div>

<style>
.stat-card {
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 0.75rem;
  padding: 1.25rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
}
.stat-icon {
  width: 56px;
  height: 56px;
  border-radius: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  flex-shrink: 0;
}
.stat-content {
  flex: 1;
}
.stat-label {
  font-size: 0.875rem;
  color: var(--gray-600);
  margin-bottom: 0.25rem;
}
.stat-value {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--gray-900);
}
.period-selector {
  display: flex;
  gap: 0.25rem;
  background: var(--gray-100);
  padding: 0.25rem;
  border-radius: 0.5rem;
}
.period-btn {
  padding: 0.375rem 0.75rem;
  border: none;
  background: transparent;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-weight: 600;
  color: var(--gray-600);
  cursor: pointer;
  transition: all 0.2s;
}
.period-btn:hover {
  background: var(--gray-200);
}
.period-btn.active {
  background: white;
  color: var(--primary-color);
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}
.client-bw-item {
  display: flex;
  align-items: center;
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border-color);
}
.client-bw-item:last-child {
  border-bottom: none;
}
.client-rank {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--gray-100);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 0.875rem;
  color: var(--gray-700);
  margin-right: 1rem;
}
.client-rank.top-1 {
  background: linear-gradient(135deg, #FFD700, #FFA500);
  color: white;
}
.client-rank.top-2 {
  background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
  color: white;
}
.client-rank.top-3 {
  background: linear-gradient(135deg, #CD7F32, #B8860B);
  color: white;
}
.client-info {
  flex: 1;
}
.client-name {
  font-weight: 600;
  font-family: 'Courier New', monospace;
  margin-bottom: 0.25rem;
}
.client-bw-bar {
  height: 6px;
  background: var(--gray-200);
  border-radius: 3px;
  overflow: hidden;
  margin-top: 0.5rem;
}
.client-bw-fill {
  height: 100%;
  background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  transition: width 0.3s ease;
}
.spinner {
  border: 3px solid var(--gray-200);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let bandwidthChart = null;
let resourceChart = null;
let currentPeriod = '24h';

async function loadAnalytics(period = '24h') {
  try {
    const response = await fetch(`/api/analytics/bandwidth?period=${period}`);
    const data = await response.json();
    
    updateStats(data);
    renderBandwidthChart(data.metrics);
    renderTopClients(data.top_clients);
    renderResourceChart(data.metrics);
  } catch (error) {
    console.error('Failed to load analytics:', error);
  }
}

function updateStats(data) {
  const metrics = data.metrics || [];
  if (metrics.length === 0) return;
  
  const latest = metrics[metrics.length - 1];
  document.getElementById('totalRx').textContent = formatBytes(latest.total_rx_bytes);
  document.getElementById('totalTx').textContent = formatBytes(latest.total_tx_bytes);
  document.getElementById('activePeers').textContent = latest.active_peers || 0;
  
  const avgCpu = metrics.reduce((sum, m) => sum + m.cpu_percent, 0) / metrics.length;
  document.getElementById('avgCpu').textContent = avgCpu.toFixed(1) + '%';
}

function renderBandwidthChart(metrics) {
  const ctx = document.getElementById('bandwidthChart');
  
  if (bandwidthChart) {
    bandwidthChart.destroy();
  }
  
  const labels = metrics.map(m => new Date(m.timestamp).toLocaleTimeString());
  const rxData = metrics.map(m => m.total_rx_bytes / (1024 * 1024)); // Convert to MB
  const txData = metrics.map(m => m.total_tx_bytes / (1024 * 1024));
  
  bandwidthChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Download (MB)',
          data: rxData,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          fill: true,
          tension: 0.4
        },
        {
          label: 'Upload (MB)',
          data: txData,
          borderColor: '#f5576c',
          backgroundColor: 'rgba(245, 87, 108, 0.1)',
          fill: true,
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'top'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' MB';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return value.toFixed(0) + ' MB';
            }
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

function renderTopClients(clients) {
  const container = document.getElementById('topClientsContainer');
  
  if (!clients || clients.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 3rem;">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>
        <p style="margin-top: 1rem;">No client data available</p>
      </div>
    `;
    return;
  }
  
  const maxTotal = Math.max(...clients.map(c => c.total));
  
  container.innerHTML = clients.map((client, index) => {
    const percentage = (client.total / maxTotal) * 100;
    const rankClass = index < 3 ? `top-${index + 1}` : '';
    
    return `
      <div class="client-bw-item">
        <div class="client-rank ${rankClass}">${index + 1}</div>
        <div class="client-info">
          <div class="client-name">${client.name}</div>
          <div style="font-size: 0.875rem; color: var(--gray-600);">
            ↓ ${formatBytes(client.rx_bytes)} &nbsp;|&nbsp; ↑ ${formatBytes(client.tx_bytes)}
          </div>
          <div class="client-bw-bar">
            <div class="client-bw-fill" style="width: ${percentage}%"></div>
          </div>
        </div>
        <div style="font-weight: 600; color: var(--gray-700);">
          ${formatBytes(client.total)}
        </div>
      </div>
    `;
  }).join('');
}

function renderResourceChart(metrics) {
  const ctx = document.getElementById('resourceChart');
  
  if (resourceChart) {
    resourceChart.destroy();
  }
  
  const labels = metrics.map(m => new Date(m.timestamp).toLocaleTimeString());
  const cpuData = metrics.map(m => m.cpu_percent);
  const memData = metrics.map(m => m.mem_used_percent);
  
  resourceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'CPU %',
          data: cpuData,
          borderColor: '#4facfe',
          backgroundColor: 'rgba(79, 172, 254, 0.1)',
          fill: true,
          tension: 0.4
        },
        {
          label: 'Memory %',
          data: memData,
          borderColor: '#43e97b',
          backgroundColor: 'rgba(67, 233, 123, 0.1)',
          fill: true,
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          position: 'top'
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            callback: function(value) {
              return value + '%';
            }
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

function changePeriod(period) {
  currentPeriod = period;
  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.period === period);
  });
  loadAnalytics(period);
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
}

// Load analytics on page load
document.addEventListener('DOMContentLoaded', () => {
  loadAnalytics('24h');
  
  // Auto-refresh every 30 seconds
  setInterval(() => {
    loadAnalytics(currentPeriod);
  }, 30000);
});
</script>
{{end}}
