{{define "content"}}
<div class="page-header">
  <h2 class="page-title">Server Status</h2>
  <p class="page-subtitle">Monitor your WireGuard VPN server</p>
</div>

<div class="card">
  <div class="card-header">
    <div class="card-title">Server Actions</div>
    <div style="display: flex; gap: 0.75rem;">
      <form method="post" action="/restart" onsubmit="return confirm('Are you sure you want to restart WireGuard?')" style="display: inline;">
        <input type="hidden" name="csrf" value="{{.CSRF}}" />
        <button type="submit" class="btn btn-secondary btn-sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
          Restart Service
        </button>
      </form>
      <form method="post" action="/backup" style="display: inline;">
        <input type="hidden" name="csrf" value="{{.CSRF}}" />
        <button type="submit" class="btn btn-primary btn-sm">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          Backup Config
        </button>
      </form>
      <a class="btn btn-outline btn-sm" href="/backup/download">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"></path><path d="M19 12l-7 7-7-7"></path></svg>
        Download Backup
      </a>
      <button type="button" class="btn btn-danger btn-sm" onclick="openUninstallModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path></svg>
        Uninstall
      </button>
    </div>
  </div>
  
  <div>
    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: var(--gray-900);">Server Output</h3>
    <div class="code-block">{{.Output}}</div>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <div class="card-title">Restore configuration</div>
  </div>
  <form method="post" action="/restore" enctype="multipart/form-data">
    <input type="hidden" name="csrf" value="{{.CSRF}}" />
    <div class="form-group">
      <label for="archive">Upload backup (.tar.gz)</label>
      <input type="file" id="archive" name="archive" accept=".gz,.tgz,.tar.gz" required />
      <div class="input-hint">Existing /etc/wireguard will be backed up automatically.</div>
    </div>
    <button class="btn btn-danger" type="submit" onclick="return confirm('Restore configuration now? This will overwrite current settings.')">Restore</button>
  </form>
</div>

<!-- Uninstall Modal -->
<div class="modal" id="uninstallModal" aria-hidden="true">
  <div class="modal-backdrop" onclick="closeUninstallModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0;font-size:1.1rem;">Confirm Uninstall</h3>
      <button class="modal-close" type="button" onclick="closeUninstallModal()">&times;</button>
    </div>
    <p style="margin-bottom:1rem;">This will remove WireGuard and likely stop this dashboard. Continue?</p>
    <div id="uninstallProgress" class="input-hint" style="margin-bottom:0.75rem;"></div>
    <form id="uninstallForm" method="post" action="/uninstall" onsubmit="return submitUninstall(event)">
      <input type="hidden" name="csrf" value="{{.CSRF}}" />
      <div style="display:flex;gap:.75rem;justify-content:flex-end;">
        <button type="button" class="btn btn-outline" onclick="closeUninstallModal()">Cancel</button>
        <button type="submit" class="btn btn-danger">Yes, Uninstall</button>
      </div>
    </form>
  </div>
  
</div>

<script>
function openUninstallModal(){ document.getElementById('uninstallModal').classList.add('open'); }
function closeUninstallModal(){ document.getElementById('uninstallModal').classList.remove('open'); }
async function submitUninstall(ev){
  ev.preventDefault();
  const prog=document.getElementById('uninstallProgress');
  prog.textContent='Uninstalling...';
  try {
    const form=ev.target;
    const fd=new FormData(form);
    const res=await fetch('/uninstall',{method:'POST',headers:{'X-Requested-With':'XMLHttpRequest'},body:fd});
    if(!res.ok){ prog.textContent='Failed: '+res.status; return false; }
    prog.textContent='Uninstall started. The service may stop shortly.';
    form.querySelector('button[type="submit"]').disabled=true;
  } catch(e){ prog.textContent='Error: '+e.message; }
  return false;
}
</script>
{{end}}
{{template "layout" .}}
