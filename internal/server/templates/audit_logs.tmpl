{{template "layout" .}}

{{define "content"}}
<div class="page-header">
  <h2 class="page-title">Audit Logs</h2>
  <p class="page-subtitle">Track all administrative actions and system events</p>
</div>

<div class="card">
  <div class="card-header">
    <div class="card-title">Recent Activity</div>
    <div style="display: flex; gap: 0.75rem;">
      <button type="button" class="btn btn-secondary btn-sm" onclick="exportLogs()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        Export CSV
      </button>
      <button type="button" class="btn btn-primary btn-sm" onclick="refreshLogs()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
        Refresh
      </button>
    </div>
  </div>

  <div class="audit-filters" style="padding: 0 1.25rem 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 220px;">
      <input type="text" id="searchLogs" placeholder="Search logs..." class="input" oninput="filterAuditLogs()" style="width: 100%;">
    </div>
    <div>
      <select id="actionFilter" class="input" onchange="filterAuditLogs()" style="width: 160px;">
        <option value="">All Actions</option>
        <option value="add_client">Add Client</option>
        <option value="revoke_client">Revoke Client</option>
        <option value="login">Login</option>
        <option value="logout">Logout</option>
        <option value="settings">Settings</option>
        <option value="migration">Migration</option>
      </select>
    </div>
    <div style="font-size: 0.75rem; color: var(--gray-600); display: flex; align-items: center;">
      Total: <span id="logCount" style="font-weight: 600; margin-left: 0.25rem;">0</span> logs
    </div>
  </div>

  <div id="logsContainer">
    <div style="padding: 3rem; text-align: center; color: var(--gray-500);">
      <div class="spinner"></div>
      <p style="margin-top: 1rem;">Loading audit logs...</p>
    </div>
  </div>

  <div id="pagination" class="pagination" style="display: none; padding: 1rem 1.25rem; border-top: 1px solid var(--border-color); justify-content: space-between; align-items: center;">
    <div style="color: var(--gray-600); font-size: 0.875rem;">
      Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
    </div>
    <div style="display: flex; gap: 0.5rem;">
      <button id="prevPage" class="btn btn-sm btn-outline" onclick="changePage(-1)" disabled>Previous</button>
      <button id="nextPage" class="btn btn-sm btn-outline" onclick="changePage(1)">Next</button>
    </div>
  </div>
</div>

<style>
.audit-log-item {
  padding: 1rem 1.25rem;
  border-bottom: 1px solid var(--border-color);
  transition: background-color 0.15s;
}
.audit-log-item:hover {
  background-color: var(--gray-50);
}
.audit-log-item:last-child {
  border-bottom: none;
}
.audit-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.5rem;
}
.audit-action {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 600;
}
.audit-icon {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
}
.audit-icon.success {
  background-color: #d1fae5;
  color: #065f46;
}
.audit-icon.error {
  background-color: #fee2e2;
  color: #991b1b;
}
.audit-meta {
  display: flex;
  gap: 1.5rem;
  font-size: 0.875rem;
  color: var(--gray-600);
}
.audit-meta-item {
  display: flex;
  align-items: center;
  gap: 0.375rem;
}
.audit-meta-item svg {
  width: 14px;
  height: 14px;
  opacity: 0.6;
}
.audit-details {
  margin-top: 0.5rem;
  padding: 0.5rem 0.75rem;
  background-color: var(--gray-50);
  border-radius: 0.375rem;
  font-size: 0.875rem;
  font-family: 'Courier New', monospace;
  color: var(--gray-700);
}
.action-badge {
  padding: 0.25rem 0.625rem;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.025em;
}
.action-badge.add {
  background-color: #d1fae5;
  color: #065f46;
}
.action-badge.revoke {
  background-color: #fee2e2;
  color: #991b1b;
}
.action-badge.login {
  background-color: #dbeafe;
  color: #1e40af;
}
.action-badge.settings {
  background-color: #fef3c7;
  color: #92400e;
}
.action-badge.migration {
  background-color: #e0e7ff;
  color: #3730a3;
}
.spinner {
  border: 3px solid var(--gray-200);
  border-top: 3px solid var(--primary-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.pagination {
  display: flex;
}
</style>

<script>
let currentPage = 1;
let totalLogs = 0;
let allLogs = [];

async function loadAuditLogs(page = 1) {
  try {
    const response = await fetch(`/api/audit-logs?page=${page}&limit=50`);
    const data = await response.json();
    allLogs = data.logs || [];
    totalLogs = data.total || 0;
    currentPage = page;
    
    renderAuditLogs(allLogs);
    updatePagination(data);
  } catch (error) {
    document.getElementById('logsContainer').innerHTML = `
      <div style="padding: 3rem; text-align: center; color: var(--error-color);">
        <p>Failed to load audit logs: ${error.message}</p>
      </div>
    `;
  }
}

function renderAuditLogs(logs) {
  const container = document.getElementById('logsContainer');
  
  if (!logs || logs.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 3rem;">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        <p style="margin-top: 1rem;">No audit logs found</p>
      </div>
    `;
    return;
  }

  container.innerHTML = logs.map(log => {
    const timestamp = new Date(log.timestamp).toLocaleString();
    const actionType = log.action.split('_')[0];
    const icon = log.success ? '✓' : '✗';
    const iconClass = log.success ? 'success' : 'error';
    
    return `
      <div class="audit-log-item">
        <div class="audit-header">
          <div class="audit-action">
            <div class="audit-icon ${iconClass}">${icon}</div>
            <span>${formatAction(log.action)}</span>
            <span class="action-badge ${actionType}">${log.action}</span>
          </div>
          <div style="font-size: 0.875rem; color: var(--gray-500);">${timestamp}</div>
        </div>
        <div class="audit-meta">
          <div class="audit-meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span>${log.username}</span>
          </div>
          <div class="audit-meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            <span>${log.resource_type}: ${log.resource_name}</span>
          </div>
          ${log.ip_address ? `
          <div class="audit-meta-item">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
            <span>${log.ip_address}</span>
          </div>
          ` : ''}
        </div>
        ${log.details ? `<div class="audit-details">${log.details}</div>` : ''}
      </div>
    `;
  }).join('');
  
  document.getElementById('logCount').textContent = totalLogs;
}

function formatAction(action) {
  return action.split('_').map(word => 
    word.charAt(0).toUpperCase() + word.slice(1)
  ).join(' ');
}

function updatePagination(data) {
  const pagination = document.getElementById('pagination');
  const totalPages = Math.ceil(data.total / data.limit);
  
  if (totalPages > 1) {
    pagination.style.display = 'flex';
    document.getElementById('currentPage').textContent = data.page;
    document.getElementById('totalPages').textContent = totalPages;
    document.getElementById('prevPage').disabled = data.page === 1;
    document.getElementById('nextPage').disabled = data.page === totalPages;
  } else {
    pagination.style.display = 'none';
  }
}

function changePage(delta) {
  loadAuditLogs(currentPage + delta);
}

function refreshLogs() {
  loadAuditLogs(currentPage);
}

function filterAuditLogs() {
  const search = document.getElementById('searchLogs').value.toLowerCase();
  const actionFilter = document.getElementById('actionFilter').value;
  
  let filtered = allLogs;
  
  if (search) {
    filtered = filtered.filter(log => 
      log.username.toLowerCase().includes(search) ||
      log.action.toLowerCase().includes(search) ||
      log.resource_name.toLowerCase().includes(search) ||
      (log.details && log.details.toLowerCase().includes(search))
    );
  }
  
  if (actionFilter) {
    filtered = filtered.filter(log => log.action === actionFilter);
  }
  
  renderAuditLogs(filtered);
}

function exportLogs() {
  // Create CSV content
  const headers = ['Timestamp', 'Username', 'Action', 'Resource Type', 'Resource Name', 'IP Address', 'Success', 'Details'];
  const rows = allLogs.map(log => [
    new Date(log.timestamp).toISOString(),
    log.username,
    log.action,
    log.resource_type,
    log.resource_name,
    log.ip_address || '',
    log.success ? 'Yes' : 'No',
    log.details || ''
  ]);
  
  const csvContent = [headers, ...rows]
    .map(row => row.map(cell => `"${cell}"`).join(','))
    .join('\n');
  
  // Download file
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `audit-logs-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Load logs on page load
document.addEventListener('DOMContentLoaded', () => {
  loadAuditLogs();
});
</script>
{{end}}
